sap.ui.define(["com/mjzsoft/demo/ui5/GeneralODataViewer/controller/BaseController","com/mjzsoft/demo/ui5/GeneralODataViewer/model/formatter","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/base/Log","sap/ui/core/Fragment"],function(e,t,a,o,i,n){"use strict";return e.extend("com.mjzsoft.demo.ui5.GeneralODataViewer.controller.Detail",{formatter:t,onInit:function(){var e=new a({tableGenerating:true,busy:false,delay:0,lineItemListTitle:this.getResourceBundle().getText("detailLineItemTableHeading"),__metadata:{uri:"URI",type:"Type"}});this.setModel(e,"detailView");var t={DataSet:[]};this._aSelectedItems=[];this._oEntity=null;var o=new a;this.setModel(o,"newDataModel");this.getModel("DataDetailModel").setData(t);this.getRouter().getRoute("object").attachPatternMatched(this._onObjectMatched,this);this.getOwnerComponent().getModel().metadataLoaded().then(this._onMetadataLoaded.bind(this))},onSendEmailPress:function(){var e=this.getModel("detailView");sap.m.URLHelper.triggerEmail(null,e.getProperty("/shareSendEmailSubject"),e.getProperty("/shareSendEmailMessage"))},onShareInJamPress:function(){var e=this.getModel("detailView"),t=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:e.getProperty("/shareOnJamTitle")}}});t.open()},onListUpdateFinished:function(e){var t,a=e.getParameter("total"),o=this.getModel("detailView");if(this.byId("lineItemsList").getBinding("items").isLengthFinal()){if(a){t=this.getResourceBundle().getText("detailLineItemTableHeadingCount",[a])}else{t=this.getResourceBundle().getText("detailLineItemTableHeading")}o.setProperty("/lineItemListTitle",t)}},_onObjectMatched:function(e){var t=e.getParameter("arguments").SetName,a=e.getParameter("arguments").EntityName,o=this.getModel("appView");this._sSetName=t;this._oEntityName=a;o.setProperty("/layout","TwoColumnsMidExpanded");o.setProperty("/busy",true);var i=this.getModel();i.metadataLoaded().then(function(){i=this.getModel();i.setUseBatch(false);i.read("/"+t,{success:function(e,i){o.setProperty("/busy",false);var n={DataSet:e.results};this.getModel("DataDetailModel").setData(n);o.setProperty("/tableGenerating",true);this.createSmartTable(a,t)}.bind(this)})}.bind(this))},createSmartTable:function(e,t){var a=this.extractEntity(e,this.getModel()),o=this.getModel("detailView");if(a){this._oEntity=a;var s=[];for(var r=0;r<a.property.length;r++){var l=a.property[r];var d=l.name;if(l.extensions){for(var h=0;h<l.extensions.length;h++){if(l.extensions[h].name==="label"){d=l.extensions[h].value;break}}}s.push({col:l.name,txt:d})}if(s.length>0){var g="",u="";for(r=0;r<s.length;r++){g+=""+"\t        <m:Column visible='true'> \n"+"\t\t       <m:customData> \n"+"\t\t\t      <core:CustomData key='p13nData' \n"+'\t\t\t\t     value=\'\\{"sortProperty":"'+s[r].col+'","filterProperty":"'+s[r].col+'","columnKey":"'+s[r].col+'","leadingProperty":"'+s[r].col+'","columnIndex":"'+r+"\"}'/> \n"+"\t\t       </m:customData> \n"+"\t\t       <m:Text text='"+s[r].txt+"'/> \n"+"\t        </m:Column> \n";u+=""+"\t\t\t   <m:Text text=\"{path:'DataDetailModel>"+s[r].col+"'}\"/> \n"}o.setProperty("/setItems",t);var c=new sap.ui.model.xml.XMLModel;c.attachRequestCompleted(function(){var e=c.getXML();e=e.replace("\x3c!--cols--\x3e",g).replace("\x3c!--cels--\x3e",u);var a=this.getView().byId("myLayout");var i=a.removeAllContent();for(var s=0;s<i.length;s++){var r=i[s];if(typeof r.destroy==="function"){r.destroy()}}n.load({type:"XML",id:t,definition:e,controller:this}).then(function(e){a.addContent(e);o.setProperty("/tableGenerating",false)})}.bind(this));c.loadData(jQuery.sap.getModulePath("com/mjzsoft/demo/ui5/GeneralODataViewer/view/")+"/SmartTable.fragment.xml")}}else{i.error("Couldn't find oEntry.")}},_bindView:function(e){var t=this.getModel("detailView");t.setProperty("/busy",false);this.getView().bindElement({path:e,events:{change:this._onBindingChange.bind(this),dataRequested:function(){t.setProperty("/busy",true)},dataReceived:function(){t.setProperty("/busy",false)}}})},_onBindingChange:function(){var e=this.getView(),t=e.getElementBinding();if(!t.getBoundContext()){this.getRouter().getTargets().display("detailObjectNotFound");this.getOwnerComponent().oListSelector.clearMasterListSelection();return}var a=t.getPath(),o=this.getResourceBundle(),i=e.getModel().getObject(a),n=i.CategoryID,s=i.CategoryName,r=this.getModel("detailView");this.getOwnerComponent().oListSelector.selectAListItem(a);r.setProperty("/saveAsTileTitle",o.getText("shareSaveTileAppTitle",[s]));r.setProperty("/shareOnJamTitle",s);r.setProperty("/shareSendEmailSubject",o.getText("shareSendEmailObjectSubject",[n]));r.setProperty("/shareSendEmailMessage",o.getText("shareSendEmailObjectMessage",[s,n,location.href]))},_onMetadataLoaded:function(){var e=this.getView().getBusyIndicatorDelay(),t=this.getModel("detailView");t.setProperty("/delay",0);t.setProperty("/lineItemTableDelay",0);t.setProperty("/busy",false)},onCloseDetailPress:function(){this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",false);this.getOwnerComponent().oListSelector.clearMasterListSelection();this.getRouter().navTo("master")},toggleFullScreen:function(){var e=this.getModel("appView").getProperty("/actionButtonsInfo/midColumn/fullScreen");this.getModel("appView").setProperty("/actionButtonsInfo/midColumn/fullScreen",!e);if(!e){this.getModel("appView").setProperty("/previousLayout",this.getModel("appView").getProperty("/layout"));this.getModel("appView").setProperty("/layout","MidColumnFullScreen")}else{this.getModel("appView").setProperty("/layout",this.getModel("appView").getProperty("/previousLayout"))}},onPressDeleteDetail:function(e){var t=this.getModel("DataDetailModel"),a=this.getKeys(this._oEntity),i,n,s,r=[],l={};for(var d=0;d<this._aSelectedItems.length;d++){n=this._aSelectedItems[d];i=t.getData().DataSet[n];for(var h=0;h<a.length;h++){r.push(i[a[h]])}l=this.concatJSON(a,r);r=[];s=this.getModel().createKey(this._sSetName,l);this.getModel().remove("/"+s,{success:function(){t.getData().DataSet.splice(n,1);t.refresh(true);o.show("Items deleted")}.bind(this),error:function(e){o.show("Delete Error")}.bind(this)});this.getModel().submitChanges({})}this.aSelectedItems=[]},onSelectionChangedDetail:function(e){var t=e.getSource().getSelectedContextPaths(),a=[];for(var o=0;o<t.length;o++){a.push(t[o].match(/\d+/g).map(Number)[0])}this._aSelectedItems=a},onTableItemPress:function(e){var t=e.getSource().getBindingContextPath();this.getModel("appView").setProperty("/layout","ThreeColumnsEndExpanded");this.getRouter().navTo("detailObject",{Set:this._sSetName,EntityName:this._oEntityName,Index:t.match(/\d+/g).map(Number)[0]})},onPressAdd:function(e){var t,a,o,i,n,s;if(!this._oAddDialog){this._oAddDialog=sap.ui.xmlfragment("detail","com.mjzsoft.demo.ui5.GeneralODataViewer.view.Add",this);this.getView().addDependent(this._oAddDialog)}this._oAddDialog.open();t=this._oAddDialog.getContent()[0].getFormContainers()[0];t.removeAllFormElements();for(var r=0;r<this._oEntity.property.length;r++){i=this._oEntity.property[r].name;n=this._oEntity.property[r].name;s=this._oEntity.property[r].type;if(this._oEntity.property[r].extensions){for(var l=0;l<this._oEntity.property[r].extensions.length;l++){if(this._oEntity.property[r].extensions[l].name==="label"){n=this._oEntity.property[r].extensions[l].value;break}}}switch(s){case"Edm.Boolean":a=new sap.m.CheckBox;a.attachSelect(this.onSelectionChange);break;case"Edm.DateTime":a=new sap.m.DatePicker({value:"{path:'newDataModel>/"+i+"',"+"type:'sap.ui.model.type.Date'}"});a.attachChange(this.onChangeDatePicker);if(this.getKeys(this._oEntity).includes(i)){a.setRequired(true)}break;default:a=new sap.m.Input({value:"{newDataModel>/"+i+"}",type:this.extractInputType(this._oEntity.property[r].type)});a.attachLiveChange(this.onInputLiveChange);if(this.getKeys(this._oEntity).includes(i)){a.setRequired(true)}break}o=new sap.ui.layout.form.FormElement({label:n,fields:a});o.data("property",i);t.addFormElement(o)}},onPressCancel:function(e){this.getModel("newDataModel").setData({});if(this._oAddDialog){if(this._oAddDialog.isOpen()){this._oAddDialog.getContent()[0].getFormContainers()[0].removeAllFormElements();this._oAddDialog.close()}}},onPressSave:function(e){var t=this.getModel("newDataModel").getData(),a=this.getModel("DataDetailModel"),i=this.getModel();i.create("/"+this._sSetName,t,{success:function(e,t){a.getData().DataSet.push(e);a.refresh(true);o.show("Successfully added a new Object")}});i.submitChanges({success:function(){},error:function(){o.show("Error")}});if(this._oAddDialog){if(this._oAddDialog.isOpen()){this._oAddDialog.getContent()[0].getFormContainers()[0].removeAllFormElements();this._oAddDialog.close()}}this.getModel("newDataModel").setData({})},onInputLiveChange:function(e){var t=e.getSource().getType(),a=e.getParameters().newValue;if(t==="Number"){a=Number(a)}this.getModel("newDataModel").setProperty("/"+e.getSource().getParent().data("property"),a)},onSelectionChange:function(e){var t=e.getSource();this.getModel("newDataModel").setProperty("/"+t.getParent().data("property"),t.getSelected())},onChangeDatePicker:function(e){var t=e.getParameter("valid"),a;if(t){a=e.getSource().getParent().data("property");this.getModel("newDataModel").setProperty("/"+a,e.getSource().getDateValue())}}})});