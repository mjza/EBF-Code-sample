sap.ui.define(["com/mjzsoft/demo/ui5/GeneralODataViewer/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","sap/ui/model/Filter","sap/ui/model/Sorter","sap/ui/model/FilterOperator","sap/m/GroupHeaderListItem","sap/ui/Device","com/mjzsoft/demo/ui5/GeneralODataViewer/model/formatter","com/mjzsoft/demo/ui5/GeneralODataViewer/js/jszip.min"],function(e,t,i,a,s,r,o,n,l,h){"use strict";return e.extend("com.mjzsoft.demo.ui5.GeneralODataViewer.controller.Master",{formatter:l,onInit:function(){this._aSelectedSets=[];var e=this.byId("list"),t=this._createViewModel(),i=e.getBusyIndicatorDelay();this._oGroupFunctions={CategoryID:function(e){var t=e.getProperty("CategoryID"),i,a;if(t<=20){i="LE20";a=this.getResourceBundle().getText("masterGroup1Header1")}else{i="GT20";a=this.getResourceBundle().getText("masterGroup1Header2")}return{key:i,text:a}}.bind(this)};this._oList=e;this._oListFilterState={aFilter:[],aSearch:[]};this.setModel(t,"masterView");e.attachEventOnce("updateFinished",function(){t.setProperty("/delay",i)});this.getView().addEventDelegate({onBeforeFirstShow:function(){this.getOwnerComponent().oListSelector.setBoundMasterList(e)}.bind(this)});this.getRouter().getRoute("master").attachPatternMatched(this._onMasterMatched,this);this.getRouter().attachBypassed(this.onBypassed,this);this.initDataModel()},initDataModel:function(){var e=this.getModel(),t=function(){var t=[];var i=e.getServiceMetadata();for(var a=0;a<i.dataServices.schema.length;a++){var s=i.dataServices.schema[a].entityContainer;if(s){var r=s[0];if(r&&r.entitySet.length>0){for(var o=0;o<r.entitySet.length;o++){t.push({SetName:r.entitySet[o].name,EntityName:r.entitySet[o].entityType})}var n={DataSet:t};var l=new sap.ui.model.json.JSONModel(n);this.setModel(l,"DataModel");return}}}}.bind(this);e.metadataLoaded().then(t)},onUpdateFinished:function(e){this._updateListItemCount(e.getParameter("total"))},onLiveSearch:function(e){if(e.getParameter("newValue").length===0){this.onSearch(e)}},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh();return}var t=e.getParameter("query");if(t){this._oListFilterState.aSearch=[new a("SetName",r.Contains,t)]}else{this._oListFilterState.aSearch=[]}this._applyFilterSearch()},onRefresh:function(){this._oList.getBinding("items").refresh()},onOpenViewSettings:function(e){if(!this._oViewSettingsDialog){this._oViewSettingsDialog=sap.ui.xmlfragment("com.mjzsoft.demo.ui5.GeneralODataViewer.view.ViewSettingsDialog",this);this.getView().addDependent(this._oViewSettingsDialog);this._oViewSettingsDialog.addStyleClass(this.getOwnerComponent().getContentDensityClass())}var t="sort";if(e.getSource()instanceof sap.m.Button){var i=e.getSource().sId;if(i.match("filter")){t="filter"}else if(i.match("group")){t="group"}}this._oViewSettingsDialog.open(t)},onConfirmViewSettingsDialog:function(e){var t=e.getParameters().filterItems,i=[],s=[];t.forEach(function(e){switch(e.getKey()){case"Filter1":i.push(new a("CategoryID",r.LE,100));break;case"Filter2":i.push(new a("CategoryID",r.GT,100));break;default:break}s.push(e.getText())});this._oListFilterState.aFilter=i;this._updateFilterBar(s.join(", "));this._applyFilterSearch();this._applySortGroup(e)},_applySortGroup:function(e){var t=e.getParameters(),i,a,r=[];if(t.groupItem){i=t.groupItem.getKey();a=t.groupDescending;var o=this._oGroupFunctions[i];r.push(new s(i,a,o))}i=t.sortItem.getKey();a=t.sortDescending;r.push(new s(i,a));this._oList.getBinding("items").sort(r)},onSelectionChange:function(e){var t=e.getSource(),i=e.getParameter("selected");if(!(t.getMode()==="MultiSelect"&&!i)){this._showDetail(e.getParameter("listItem")||e.getSource())}},onBypassed:function(){this._oList.removeSelections(true)},createGroupHeader:function(e){return new o({title:e.text,upperCase:false})},onNavBack:function(){var e=i.getInstance().getPreviousHash(),t=sap.ushell.Container?sap.ushell.Container.getService("CrossApplicationNavigation"):undefined;if(e!==undefined||!t||!t.isInitialNavigation()){history.go(-1)}else{t.toExternal({target:{shellHash:"#Shell-home"}})}},_createViewModel:function(){return new t({isFilterBarVisible:false,filterBarLabel:"",delay:0,title:this.getResourceBundle().getText("masterTitleCount",[0]),noDataText:this.getResourceBundle().getText("masterListNoDataText"),sortBy:"SetName",groupBy:"None"})},_onMasterMatched:function(){this.getModel("appView").setProperty("/layout","OneColumn")},_showDetail:function(e){var t=!n.system.phone;this.getModel("appView").setProperty("/layout","TwoColumnsMidExpanded");this.getRouter().navTo("object",{SetName:e.getBindingContext("DataModel").getProperty("SetName"),EntityName:e.getBindingContext("DataModel").getProperty("EntityName")},t)},_updateListItemCount:function(e){var t;if(this._oList.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("masterTitleCount",[e]);this.getModel("masterView").setProperty("/title",t)}},_applyFilterSearch:function(){var e=this._oListFilterState.aSearch.concat(this._oListFilterState.aFilter),t=this.getModel("masterView");this._oList.getBinding("items").filter(e,"Application");if(e.length!==0){t.setProperty("/noDataText",this.getResourceBundle().getText("masterListNoDataWithFilterOrSearchText"))}else if(this._oListFilterState.aSearch.length>0){t.setProperty("/noDataText",this.getResourceBundle().getText("masterListNoDataText"))}},_updateFilterBar:function(e){var t=this.getModel("masterView");t.setProperty("/isFilterBarVisible",this._oListFilterState.aFilter.length>0);t.setProperty("/filterBarLabel",this.getResourceBundle().getText("masterFilterBarText",[e]))},onCheckBoxSelect:function(e){var t=e.getSource(),i=t.getName();if(t.getSelected()===true){this._aSelectedSets.push(i)}else{for(var a=0;a<this._aSelectedSets.length;a++){if(this._aSelectedSets[a]===i){this._aSelectedSets.splice(a,1);break}}}},onDownload:function(e){var t=this.getModel();this._aAborts=[];this._oZip=new JSZip;this._iCounter=this._aSelectedSets.length;for(var i=0;i<this._aSelectedSets.length;i++){var a=t.read("/"+this._aSelectedSets[i],{success:function(e,t,i){this._oZip.file(e+".json",JSON.stringify(t.results));if(--this._iCounter===0){this._downloadZipObject()}}.bind(this,this._aSelectedSets[i]),error:function(e){if(--this._iCounter===0){this._downloadZipObject()}}.bind(this)});this._aAborts.push(a)}},_downloadZipObject:function(){this._oZip.generateAsync({type:"base64"}).then(function(e){window.location.href="data:application/zip;base64,"+e})}})});